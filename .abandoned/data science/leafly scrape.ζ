# let's do this the poor way
################################### strain id ##################################
https://www.leafly.com/explore/sort-newest
setInterval(()=> $('.ga_Explore_LoadMore').click() ,2*1e3)
# wait to load
# @2017-11-19T15:58Z finds 2304 results instead of the promised 2327 but that's good enough
r = $('a > .strain-tile').toArray().map(Î¹=> location.origin + $(Î¹).parent().attr('href') )
r = _.uniq(r.sort(),true)
copy(JSON.stringify(r))
@device`ð…©ð…œð…œð…ªð…«`.Î¹ = JSON.parse(p())
################################## strain data #################################
@device`ð…©ð…œð…œð…ªð…«`.Î¹.forEach((Î¹,i)=>{ cn.log('GET_L',i) ;GET_L(Î¹,âˆž) })
################################### review id ##################################
node --max_old_space_size=25000 /usr/local/bin/Î¶
q0 â† Î¹=> cn.log('scraping',Î¹)
q1 â† _u.throttle(q0,20*1e3)
@device`ð…©ð…œð…œð…ªð…«`.Î¹.map(memoize_persist((Î¹,i2)=>{tâ†;
	r â† []
	for( iâ†0 ; ;i++ ){
		r2 â† (GET_L(`${Î¹}/reviews?page=${i}&sort=date`,2e5)+'')
			|>(Î¹=> (Î¹.match((t=/<a.*?href="(.*?)".*>Read Full Review<\/a>/).g)||[]).map(.match(t)[1]) )
		r.push(â€¦r2)
		if( r2.â€– ) q1([i2,i])
		else{ q0([i2,i]) ;break } }
	â†© r }))
@device`ð…©ð…©ð…©ð…­ð…«`.Î¹ = _.sortBy(t)._.uniq(true)
################################ review parsing ################################
100..map(=>{ i â† random(1761) ;â†© random(Ï†`~/file/leaf_review/${i}.json`.json)[1] })
.map((Î¹,i)=> Ï†`~/file/leaf_sample/${i}.html`.text = Î¹ )

for i0 in {7..176}; do
node --max_old_space_size=10000 /usr/local/bin/Î¶ '
i0 â† '"$i0"' ;_.range(1761).chunk(10)[i0].mapâ€¦(i1=> Ï†`~/file/leaf_review/${i1}.json`.json.map((Î¹,i2)=>{
	if(! Î¹[1].re`<h2 class="heading--lg">(.*?)</h2>` ) â†©;
	dom â† new (npm`jsdom@11.4.0`.JSDOM)(Î¹[1])
	$ â† Î¹=> [â€¦dom.window.document.querySelectorAll(Î¹)]
	ð…©1 â† Î¹=>{ t â† $("h1,h2").filter(.textContent===Î¹)[0] ;â†© t && t.parentElement }
	ð…©2 â† Î¹=> [â€¦Î¹.querySelectorAll("li")].map(.textContent)
	iâ†; tâ†; â†© {
	,about: $(".strain-link")[0].href
	,at: $("time")[0].dateTime
	,user: ð…©1("Reviewed By").querySelector("a").href
	,text: $(".m-review")[0].firstElementChild.textContent
	,rating: $("[star-rating]").map(.getAttribute("star-rating")).filter(.re`^\d$`)[0]|0
	,[i="Form & Method"]: ð…©2(ð…©1(i))
	,[i="Effects"]: ð…©2(ð…©1(i))
	,[i="Flavor Profile"]: ð…©2(ð…©1(i))
	,[i="Acquired From"]: (t = ð…©1("Acquired From") ,t && t.querySelector("a").href)
	} }).filter(Î¹=>Î¹) ) |>(Î¹=>{ Ï†`~/file/leaf_review_2/${i0}.json`.Î¹ = Î¹ })
;'
done

Ï†`~/file/leaf_review.json`.Î¹ = _.range(177).mapâ€¦(i=> Ï†`~/file/leaf_review_2/${i}.json`.json )
Ï†`~/file/leaf_strain.json`.Î¹ = _.range(24).mapâ€¦(i=> Ï†`~/Downloads/leaf_strain_Î¹/${i}.json`.json )
################################ strain parsing ################################
@device`ð…©ð…œð…œð…ªð…«`.Î¹.map((Î¹,i)=> Ï†`~/file/leaf_strain/${i}.html`.text = GET_L(Î¹,âˆž) )
100..map(=> random(@device`ð…©ð…œð…œð…ªð…«`.Î¹)).map((Î¹,i)=> Ï†`~/file/leaf_strain_sample/${i}.html`.text = GET_L(Î¹,âˆž) )

for i0 in {0..23}; do
node --max_old_space_size=10000 /usr/local/bin/Î¶ '
closest â† (Î¹,sel)=>{ while( Î¹ ){ if( Î¹.matches(sel) ) â†© Î¹ ;Î¹ = Î¹.parentElement } }
i0 â† '"$i0"' ;t0 â† @device`ð…©ð…œð…œð…ªð…«`.Î¹ ;_.range(t0.â€–).chunk(100)[i0].map(i1=>{
	name â† t0[i1]
	Î¹ â† GET_L(name,âˆž)
	dom â† new (npm`jsdom@11.4.0`.JSDOM)(Î¹)
	doc â† dom.window.document
	$ â† (el,Î¹)=> [â€¦el.querySelectorAll(Î¹)]
	ð…©1 â† Î¹=>{ t â† $(doc,"h1,h2").filter(.textContent===Î¹)[0] ;â†© t && closest(t,"section") }
	iâ†; tâ†; â†© {
	,name: name.replace(/^https\:\/\/www\.leafly\.com/,"")
	,[i="Strain Highlights"]: (=>{ Î¹ â† ð…©1(i) ;â†© Î¹ && $(Î¹,".description")[0].textContent })()
	,[i="Most Popular In"]: (=>{ Î¹ â† ð…©1(i) ;â†© Î¹ && $(Î¹,"a").map(.href) })()
	,[i="Flavors"]: (=>{ Î¹ â† ð…©1(i) ;â†© Î¹ && $(Î¹,"li").map(.getAttribute("title")) })()
	,"lineage": (=>{ Î¹ â† ð…©1("Strain Data") ;if(!Î¹)â†© ;Î¹ = $(Î¹,".strain__lineage li a") ;if(!Î¹)â†© ;â†© Î¹.map(.href) })()
	,[i="Strain Data"]: (=>{ try{ Î¹ â† ð…©1(i) ;if(!Î¹)â†© ;Î¹ = $(Î¹,".growInfoRow") ;if(!Î¹)â†© ;â†© Î¹.map(Î¹=>[ Î¹.textContent.trim().split(/\s+/)[0] ,$(Î¹,"div.selected")[0].textContent.trim() ]) }catch(e){} })()
	,"Strain Attributes": (=>{ Î¹ â† $(doc,".strain__attributes")[0] ;if(!Î¹)â†© ;Î¹ = $(Î¹,".m-histogram-item-wrapper") ;if(!Î¹)â†© ;â†© Î¹.map(Î¹=>[ $(Î¹,".m-attr-label")[0].textContent ,+$(Î¹,".m-attr-bar")[0].style._values.width.replace(/%$/,"")/100 ]) })()
	} }) |>(Î¹=>{ Ï†`~/Downloads/leaf_strain_Î¹/${i0}.json`.Î¹ = Î¹ })
;'
done
