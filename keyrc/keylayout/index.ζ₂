#!/usr/bin/env ζ₂

__dirname ← fs('~/ali/github/scratch/keyrc/keylayout').path+'/'

id ← -18673 // (-10000 + -Math.floor(Math.random()*10000))+''

make_it ← λ(){↩ fs(__dirname+'lackey.keylayout.template').$
	.replace('__ID__',id+'')
	.replace('__KEYMAPSET__', [
		['a','s','d','f','h','g','z','x','c','v',167,'b','q','w','e','r','y','t','1','2','3','4','6','5','=','9','7','-','8','0',']','o','u','[','i','p',13,'l','j','\'','k',';','\\',',','/','n','m','.',9,' ','`',8,3,27,0,0,0,0,0,0,0,0,0,0,0,'.',29,'*',0,'+',28,27,31,0,0,'/',3,30,'-',0,0,'=','0','1','2','3','4','5','6','7',0,'8','9',0,0,0,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,5,1,11,127,16,4,16,12,16,28,29,31,30,0],
		['A','S','D','F','H','G','Z','X','C','V',177,'B','Q','W','E','R','Y','T','!','@','#','$','^','%','+','(','&','_','*',')','}','O','U','{','I','P',13,'L','J','"','K',':','|','<','?','N','M','>',9,' ','~',8,3,27,0,0,0,0,0,0,0,0,0,0,0,'.','*','*',0,'+','+',27,'=',0,0,'/',3,'/','-',0,0,'=','0','1','2','3','4','5','6','7',0,'8','9',0,0,0,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,5,1,11,127,16,4,16,12,16,28,29,31,30,0],
		['A','S','D','F','H','G','Z','X','C','V',167,'B','Q','W','E','R','Y','T','1','2','3','4','6','5','=','9','7','-','8','0',']','O','U','[','I','P',13,'L','J','\'','K',';','\\',',','/','N','M','.',9,' ','`',8,3,27,0,0,0,0,0,0,0,0,0,0,0,'.',29,'*',0,'+',28,27,31,0,0,'/',3,30,'-',0,0,'=','0','1','2','3','4','5','6','7',0,'8','9',0,0,0,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,5,1,11,127,16,4,16,12,16,28,29,31,30,0],
		[[10],,[13],[15],,,,,[12],,,[11],,,[14],,,,[1],[2],[3],[4],[6],[5],,[9],[7],,[8],[0],,,,,,,,,,,,,,,,,,,,,,8,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,[0],[1],[2],[3],[4],[5],[6],[7],,[8],[9],,,,,,,,,,,,,,,,,,,,,,5,1,11,127,16,4,16,12,16,28,29,31,30,],
		[1,19,4,6,8,7,26,24,3,22,'0',2,17,23,5,18,25,20,'1','2','3','4','6','5','=','9','7',31,'8','0',29,15,21,27,9,16,13,12,10,'\'',11,';',28,',','/',14,13,'.',9,' ','`',8,3,27,0,0,0,0,0,0,0,0,0,0,0,'.',29,'*',0,'+',28,27,31,0,0,'/',3,30,'-',0,0,'=','0','1','2','3','4','5','6','7',0,'8','9',0,0,0,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,5,1,11,127,16,4,16,12,16,28,29,31,30,0],
		].map(λ(l,i){↩ '<keyMap index="'+i+'">\n'+l.map(λ(ι,k){
			↩ '<key code="'+k+'" '+(ι instanceof Array? 'action="'+ι[0] : 'output="&#x'+('0000'+(typeof(ι)==='string'? ι.charCodeAt(0) : ι)).slice(-4)+';')+'"/>'
			}).filter(λ(ι){↩ ι}).join('\n')+'\n</keyMap>'}).join('\n') ) }

t ← make_it()
fs('~/Downloads/x.txt').$ = t
if (!(fs('~/Library/Keyboard Layouts/lackey.keylayout').$ === t)) {
	id += 1; t = make_it()
	print('!! writing new layout !!')
	print('you may need to manually set the new layout in System Preferences → Keyboard → Input Sources and then reboot your computer')
	print('new id:',id)
	fs.writeFileSync(fs('~/Library/Keyboard Layouts/lackey.icns').path, fs.readFileSync(__dirname+'lackey.icns'))
	fs('~/Library/Keyboard Layouts/lackey.keylayout').$ = t
	}
