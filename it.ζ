################################# data : basic #################################

################################# data : parse #################################
‚ß´. regex_set ==> Œπ=>{
	# ! low quality ,scrap
	Œπ = (Œπ+'').replace(/\n$/,'')
	t‚Üê[] ;[‚Ä¶[‚Ä¶Œπ].‚à™([])]._.sortBy().map(Œπ=>{ Œπ = ord(Œπ) ;t[-1]&&t[-1][1] === Œπ-1? (t[-1][1] = Œπ) : t.push([Œπ,Œπ]) })
	x ‚Üê Œπ=>{ Œπ = chr(Œπ) ;‚Ü© {'-':1,']':1,'\\':1}[Œπ]? '\\'+Œπ : Œπ==="'"? Œπ : node.util.inspect(Œπ).slice(1,-1).replace(/\\u00/g,'\\x') }
	Œπ = t.map(Œπ=> Œπ[0] === Œπ[1]? x(Œπ[0]) : Œπ[0] === Œπ[1]-1? x(Œπ[0])+x(Œπ[1]) : x(Œπ[0])+'-'+x(Œπ[1]) ).join('')
	‚Ü© Œπ }

‚ß´. schema ==>{
	sc_merge ‚Üê (a,b)=>{ ak ‚Üê _u.keys(a) ;bk ‚Üê _u.keys(b) ;bk.-(ak).forEach(k=> a[k] = b[k]) ;ak.‚à©(bk).forEach(k=> a[k] = !Tprim(a[k])? sc_merge(a[k],b[k]) : !Tprim(b[k])? 'error' : a[k]) ;‚Ü© a }
	‚Ü© Œπ=> T.boolean(Œπ)? ‚úì : Tstr(Œπ)? '' : Tnum(Œπ)? 0 : Tarr(Œπ)? !Œπ.‚Äñ? [] : [Œπ.map(schema).fold(sc_merge)] : _u.pairs(Œπ).map(Œπ=> [Œπ[0],schema(Œπ[1])])._.object()
	}

################################## data : time #################################

################################ data : numeric ################################
‚ß´. numeric2 ==>{
	nk ‚Üê npm`numeric@1.2.6`
	norm‚àû ‚Üê Œπ=> nk.div( Œπ ,Œπ.fold(nk.max.XX) )
	norm1 ‚Üê Œπ=> nk.div( Œπ ,Œπ.fold(nk.add.XX) )
	mean ‚Üê Œπ=> nk.diveq( Œπ.fold(nk.add.XX) ,Œπ.‚Äñ )
	norm‚àû_affine_sorted_E ‚Üê Œπ=>( nk.subeq(Œπ,Œπ[0]) ,nk.diveq(Œπ,Œπ[-1]) )
	‚Ü© {,nk,norm‚àû,norm1,mean,norm‚àû_affine_sorted_E} }
‚ß´. normal_PDF ==> x=>{ Œº ‚Üê 0 ;œÉ ‚Üê 1 ;v ‚Üê œÉ**2 ;‚Ü© 1/sqrt(v*œÑ)*exp(-((x-Œº)**2)/(2*v)) }
‚ß´. normal_CDF ==> x=>{ Œº ‚Üê 0 ;œÉ ‚Üê 1 ;‚Ü© (1 + npm`math-erf@1.0.0`( (x-Œº) / (œÉ*sqrt(2)) ))/2 }

################################# data : color #################################
‚ß´. color ==>{
	color ‚Üê npm`color@2.0.1`
	color.interpolate_0 = (c,x)=>{ x *= c.‚Äñ ;i ‚Üê x|0 ;r ‚Üê x-i ;‚Ü© c[i%c.‚Äñ].mix(c[(i+1)%c.‚Äñ] ,1-r) }
	color.prototype‚Äò.i .get= Œª(){ Œπ ‚Üê @.rgb().color ;‚Ü© ( Œπ[0]<<24 | Œπ[1]<<16 | Œπ[2]<<8 | 0xff )>>>0 }
	‚Ü© color }

######################### net incl context device,proc #########################
‚ß´. lock ==>{
	fs ‚Üê node.fs ;util ‚Üê node.util
	;fs_close ‚Üê util.promisify(fs.close) ;fs_unlink ‚Üê util.promisify(fs.unlink) ;fs_open ‚Üê util.promisify(fs.open)
	locks ‚Üê {}
	êÖ®êÖØ ‚Üê id=> œÜ`/tmp/lock_${id}`+''
	‚ôì_on_exits(=> _u.keys(locks).map(id=>{ try{ fs.unlinkSync(êÖ®êÖØ(id)) }catch(e){} }) )
	lock ‚Üê (id,opt)=> fs_open(êÖ®êÖØ(id),'wx').then(
		,fd=>( locks[id] = ‚úì ,fs_close(fd).then(=> =>lock.un(id) ) )
		,e=>{ T.Error(e) || ‚ÄΩ ;opt||(opt={}) ;'wait' in opt ||(opt.wait = 0)
			if(!( e.code==='EEXIST' && opt.wait > 0 )) ‚Ü© Œ†(e)
			else{ w ‚Üê min(opt.wait,0.1) ;opt.wait -= w ;‚Ü© (=> lock(id,opt)).in_Œ†(w) }
			} )
	lock.un = id=>( delete locks[id] ,fs_unlink(êÖ®êÖØ(id)) )
	lock.‚àÉ = id=> fs_open(êÖ®êÖØ(id),'r').then(
		,fd=>( fs.close(fd) ,‚úì )
		,e=> e.code==='ENOENT'? ‚úó : Œ†(e) )
	‚Ü© lock }

‚ß´. stream4 ==>{ E ‚Üê {}
	E.send_json = memoize_weak(s=>{ ;t ‚Üê npm`through2@2.0.3`.obj((Œπ,À£,cb)=>cb(‚àÖ,JSON.stringify(Œπ)+'\n')) ;t.pipe(s) ;‚Ü© t‚Äò.write .f })
	E.as_json = memoize_weak(s=>{ ;t ‚Üê npm`split2@2.2.0`(Œπ=>{ try{‚Ü© JSON.parse(Œπ) }catch(e){ @.emit('error',e) } }) ;s.pipe(t) ;‚Ü© t.P`data` })
	‚Ü© E }

‚ß´. net1 ==>{ E ‚Üê {}
	E.open_send = at=> Œ†((yes,no)=>{ if(! at )‚Ü© no() ;r ‚Üê new node.net.Socket() ;r.unref().on('error',no).connect(at).on('connect',=>yes(r)) })
	E.device_listen = (port=0)=>{ r ‚Üê new node.net.Server().listen(port,'localhost') ;‚Ü© r.Œ†`listening`.then(=> r) }
	node.net.Server.prototype.just_first_json = Œª(){‚Ü© @.Œ†`connection`.then(s=> stream4.as_json(s).Œ†.then(Œπ=>{ ;s.end() ;@.close() ;‚Ü© Œπ })) }
	node.net.Server.prototype‚Äò.at .get= Œª(){t‚Üê ;‚Ü© @.êÖ≠êÖùêÖØêÖ®êÖã||(@.êÖ≠êÖùêÖØêÖ®êÖã= [(t=@.address()).address,t.port]) }
	E._0_œÜ_seenbydevice0 = Œπ=>{ t ‚Üê @device0buf('êÖ¶êÖØêÖ≠êÖ™_'+Œπ) ;‚Ü© t.o.‚àÉ? Œ†(t) : Œ†(yes=> npm`simple-get@2.7.0`.concat(Œπ,(e,r,Œπ)=>{ t.Œπ = Œπ ;yes(t) }) ) }
	E._0_œÜ_seenbydevice0‚Åª¬π = => node.fs.readdirSync(device0_n1_dir).filter(.re`^êÖ¶êÖØêÖ≠êÖ™_`).map(Œπ=> device0_n1_dir+'/'+Œπ)
	‚Ü© E }

‚ß´. Œ† ==> Œπ‚áí
	: Tfun(Œπ) && /^(re|yes|\(yes,no\))=>/.test(Œπ+'')? new Promise(Œπ)
	: T.Error(Œπ)? Œ†x(Œπ)
	: Promise.resolve(Œπ)
‚ß´. Œ†x ==> Œπ=> Promise.reject(Œπ)
‚ß´. Œ†and ==> (‚Ä¶Œπ)=> Promise.all( Œπ.‚Äñ===1? Œπ[0] : Œπ )
‚ß´. Œ†or ==> (‚Ä¶Œπ)=> Promise.race( Œπ.‚Äñ===1? Œπ[0] : Œπ )

‚ß´. @deviceŒ† = => Œπ=>{ start ‚Üê Tfun(Œπ)
	œÜ_on_E ‚Üê Œπ=> Œ†(re=>{ êÖ™ ‚Üê Œπ.‚àÉ? re() : npm`chokidar@2.0.0`.watch(Œπ+'',{persistent:‚úì}).on('all',=> Œπ.‚àÉ &&( êÖ™.close() ,re() )) })
	id ‚Üê !start? Œπ : random_id.greek(9)
	êÖû ‚Üê @device0('Œ†'+id)
	re ‚Üê (Œπ=>{ êÖû.Œπ = Œπ }) ‚Ä¶‚Üê({ ,id ,toString:=>r+'.re' })
	r ‚Üê { ,id ,re ,toString:=>Œ∂js`@deviceŒ†(${id})` } !>(‚Äò.Œ† .get==> œÜ_on_E(êÖû.o).then(=> êÖû.Œπ))
	start && Œπ(re)
	‚Ü© r }

############################### friend glue : ui ###############################
‚ß´. electron_window_for ==>{
	# interaction with previous versions: unsolved
	êÖ© ‚Üê {
		,init:=> _electron__start_my().Œ†
		,Œπ: @device0`êÖ∞êÖÉêÖ¨êÖ¶êÖúelectron`
		# @proc alive_at: time of last message received from
		# @proc path_to
		,path_init:=> !êÖ©.Œπ.Œπ? Œ†x() :( êÖ©.path_to = net1.open_send(êÖ©.Œπ.Œπ[1]) !>(.then(Œπ=> Œ†or(Œπ.Œ†`close`,Œπ.Œ†`end`).then(=> êÖ©.path_to = ‚àÖ ) ,=>‚àÖ)) )
		,path_to:‚àÖ
		}
	send_to_my ‚Üê Œπ=>{
		êÖØ ‚Üê => êÖ©.path_init() !>(.then(s=> stream4.send_json(s)(Œπ) ,=>‚àÖ))
		êÖØ().catch(=>{
			lock('êÖÇêÖÇêÖ™êÖØêÖ© electron init').then(
				,un=> êÖ©.init().then(Œπ=>{ un() ;êÖ©.Œπ.Œπ = Œπ ;êÖØ().catch(=>‚àÖ) } ,un)
				,=> /* retry once */ (=> êÖØ().catch(=>‚àÖ) ).in(1/*holy shit cheating*/)
				)
			}) }
	‚Ü© id=> code=> send_to_my({ ,id ,code:repr_fi(code) }) }
‚ß´. _electron__start_my ==>{
	start_el_app ‚Üê (code,‚Ä¶a)=>{
		cmd ‚Üê npm`electron@1.8.2-beta.2` ;t ‚Üê cmd_log_loc(cmd)
		c2 ‚Üê `require('/usr/local/bin/Œ∂') ;(${code})(${a.join(',')})`
		node.child_process.spawn(sh`${cmd} ${simple_as_file(c2)}`,{ ,shell:‚úì ,detached:‚úì ,stdio:['ignore',node.fs.openSync(t.out,'a+'),node.fs.openSync(t.err,'a+')] })
		|>(Œπ=> [Œπ,‚Ä¶Œπ.stdio,Œπ.channel].map(Œπ=>Œπ&&Œπ.unref()) )
		}
	‚Ü© => @deviceŒ†(re=> start_el_app(re=>{ ;el ‚Üê require('electron') ;el.app.Œ†`ready`.then(=>{
		el.app.on('window-all-closed',=> el.app.hide() )
		imgur`1uoWV5c`.then(Œπ=> el.app.dock.setIcon(Œπ.@device) )
		on_msg ‚Üê ({,id,code})=>{ w ‚Üê êÖÆêÖ≠êÖ∞êÖÇêÖÆ‚Äò[id]
			send ‚Üê Œπ=> w.Œπ.webContents.executeJavaScript(Œπ+';0')
			if(! w.Œπ ){
				t ‚Üê w.Œπ = new el.BrowserWindow({ ,show:‚úó ,frame:‚úó }) # !>(êÖ¶)
				t.loadURL('about:blank')
				t.Œ†`closed`.then(=> w.‚àÉ = ‚úó )
				send(` ;require('/usr/local/bin/Œ∂') ;Œ≥.el = require('electron') `)
				t.Œ†`ready-to-show`.then(=> t.show()) }
			send(code) } ;êÖÆêÖ≠êÖ∞êÖÇêÖÆ ‚Üê {}
		net1.device_listen().then(H=>{ H.on('connection',s=> stream4.as_json(s).on(on_msg) ) ;re(H.at) })
		})},re) ) }

‚ß´. notify ==> Œπ=>{
	Tstr(Œπ) &&( Œπ = Œπ.re`\n`? Œπ.re`^(.*?)\n([^]*)`.slice(1) : Œπ.re` `? Œπ.re`^(.*?) ([^]*)`.slice(1) : [Œπ] )
	‚Ü© net1.device_listen().then(H=>{
	r ‚Üê H.just_first_json()
	hs·µ•`hs.notify.new(
		function(x) ;x:withdraw() ;simple_send(${H.at},{ at=x:actualDeliveryDate() }) end
		,{ title=${Œπ[0]} ,informativeText=${or‚àÖ(Œπ[1],'')} ,otherButtonTitle='\u{2063}' ,actionButtonTitle='\u{2063}' }
		):send()`
	‚Ü© r }) }

# ‚ß´. set_newtab_bg ==> Œπ=> sh·µ•`ln -sf ${Œπ} ~/code/scratch/user.net/chrome:newtab/it.jpg`
‚ß´. set_newtab_bg ==> Œπ=>{
	d ‚Üê @device0`chrome:newtab`.o
	d.œÜ`it.html`.text = js` <meta charset="utf-8"> <title>‚†Ä</title> <style>
		html,body {
			;height:100% ;width:100% ;margin:0
			;background:url(${Œπ}) ;background-position:50% 50% ;background-size:cover
			} </style> `
	d.œÜ`manifest.json`.json = { ,manifest_version:2 ,name:'newtab' ,version:'1' ,description:'' ,chrome_url_overrides:{ ,newtab:'it.html' } } }

‚ß´. style ==> Œπ=> document.head.appendChild( document.createElement('style') ‚Ä¶‚Üê({ innerHTML:Œπ+'' }) )
‚ß´. eval_html0 ==> Œπ=> document.createElement('div') ‚Ä¶‚Üê({ innerHTML:(Œπ+'').trim() }).childNodes[0]
‚ß´. html_clear ==> =>{ ;document.write('') ;document.close() }

############################## friend glue : data ##############################
‚ß´. wikipedia_source ==> page=> JSON.parse(GET_L(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(page)}&prop=revisions&rvprop=content&format=json`,1e6)+'').query.pages |> (Œπ=> _u.values(Œπ)[0].revisions[0]['*'] )

‚ß´. github_url ==> Œπ=>{
	[file,h] ‚Üê sb·µ•`view = deserialize(${Œπ}) ;s = view.sel() ;[ view.file_name() ,[view.rowcol(Œπ) for Œπ in [s[0].begin() ,s[-1].end()]] ]`
	fm ‚Üê Œπ=> 'L'+(Œπ+1)
	‚Ü© github_remote_origin(file||'')+( ‚âà(h[0],h[1])? '' : '#'+(h[0][0]===h[1][0]? fm(h[0][0]) : fm(h[0][0])+'-'+fm(h[1][0])) ) }
‚ß´. github_remote_origin ==> file=>{
	Œπ ‚Üê œÜ(file).root('/')
	root ‚Üê Œπ ;while( root+''!=='/' && !root.œÜ`.git`.‚àÉ ) root=root .œÜ`..`
	if( root+''==='/' ) throw Error() ‚Ä¶‚Üê ({ human:'did not find github remote origin for '+(file||'<anon>') })
	Œπ = (Œπ+'').slice((root+'/').‚Äñ)
	name ‚Üê root.œÜ`.git/config`.ini['remote "origin"'].url.match(/github\.com[:/](.+)\/(.+)\.git/).slice(1).join('/')
	commit ‚Üê /*jet[*/ catch_Œπ(=> root.œÜ`.git/HEAD`.text.trim()==='ref: refs/heads/master' && root.œÜ`.git/refs/heads/master`.text.trim() ) /*]*/ || sh·µ•`cd ${root} ;git rev-parse HEAD`+''
	‚Ü© encodeURI('http://github.com/'+name+'/blob/'+commit+'/'+Œπ) }

‚ß´. hand ==> slot0(
	,=> hs·µ•`json({ hs.pasteboard.getContents() })`[0]
	,Œπ=> hs·µ•`hs.pasteboard.setContents(${Œ∂_inspect(Œπ)}) ;hs.alert('‚úç')` )

‚ß´. chrome_tabs ==> i=>{
	nice_ ‚Üê (title,url)=>{ t ‚Üê new String(title+' '+url) ;t.sourcemap = { ,title:[0,title.‚Äñ] ,url:[(title+' ').‚Äñ,(title+' '+url).‚Äñ] } ;‚Ü© nice_url(t) }
	[title,url] ‚Üê osa·µ•`chrome: {title,URL} of tabs of windows`
	if( i ){ i = i|0 ;t ‚Üê nice_(title[0][i],url[0][i]) ;p(t) ;‚Ü© t+'\n<copied>\n' }
	else{ t ‚Üê _.zip(title,url).map(Œπ=> _.zip(‚Ä¶Œπ)).map(.map(Œπ=> nice_(‚Ä¶Œπ)).join('\n')).join('\n\n') ;sb.tab.push(t) }
	}

‚ß´. bookmarks ==> Œπ=>{
	# ! should use nice_url
	use_chrome ‚Üê ‚úì
	safari_bookmarks ‚Üê Œπ=>{
		êÖúêÖ´ ‚Üê Œπ‚áí
			: Tarr(Œπ)? Œπ.map‚Ä¶(êÖúêÖ´)
			: Œπ.WebBookmarkType==='WebBookmarkTypeProxy'? []
			: Œπ.WebBookmarkType==='WebBookmarkTypeLeaf'? [{ ,name:Œπ.URIDictionary.title ,Œπ:Œπ.URLString }]
			: Œπ.WebBookmarkType==='WebBookmarkTypeList'? !Œπ.Children? [] : [{ ,name:Œπ.Title ,Œπs:Œπ.Children.map‚Ä¶(êÖúêÖ´) }]
			: { ,name:'' ,Œπ:JSON.stringify(Œπ) }
		‚Ü© êÖúêÖ´(œÜ(Œπ||œÜ`~/Library/Safari/Bookmarks.plist`).plist)[0].Œπs }
	chrome_bookmarks ‚Üê Œπ=>{
		êÖúêÖ´ ‚Üê Œπ=> Œπ.children? { ,name:Œπ.name ,Œπs:Œπ.children.map(êÖúêÖ´) } : Œπ.url? { ,name:Œπ.name ,Œπ:Œπ.url } : { ,name:'' ,Œπ:JSON.stringify(Œπ) }
		‚Ü© œÜ(Œπ||'~/Library/Application Support/Google/Chrome/Default/Bookmarks').json.roots.bookmark_bar.children.map(êÖúêÖ´) }
	Œπ = ( use_chrome? chrome_bookmarks : safari_bookmarks )(Œπ)
	Œπ = walk_fold(Œπ,Œπ=> Tarr(Œπ)? Œπ.join('\n') : Œπ.Œπs? (Œπ.name+'\n'+Œπ.Œπs).replace(/\n/g,'\n  ') : ( !Œπ.name || !Œπ.Œπ || Œπ.Œπ === Œπ.name? Œπ.name||Œπ.Œπ : Œπ.name+' '+Œπ.Œπ ))
	sb.tab.push(Œπ) }

‚ß´. p ==> slot0(
	,=>{ if(!Œ≥.êÖÉêÖúêÖ≠êÖã){ Œ≥.êÖÉêÖúêÖ≠êÖã=‚úì ;if( node.fs.fstatSync(0).isFIFO() ){ process.stdin.pin().then(Œπ=> hand.Œπ = Œπ+'') ;‚Ü© } }; ‚Ü© hand.Œπ  }
	,Œπ=> hand.Œπ = Œπ ) ‚Ä¶‚Üê({ cant_pool:‚úì })

‚ß´. sb ==>{
	sb ‚Üê ((‚Ä¶a)=> node.fs.fstatSync(0).isFIFO()? sh‚Çêi`open -a 'Sublime Text.app' -f` |>(=>‚àÖ) : a.‚Äñ===0? sb.tab.active.Œπ : sh‚Çêi`'/Applications/Sublime Text.app/Contents/SharedSupport/bin/subl' ${a}` |>(=>‚àÖ) )
		‚Ä¶‚Üê({ cant_pool:‚úì })
	sb‚Äò.tab .get= =>{
		r ‚Üê sb·µ•`[serialize(Œπ) for Œπ in [Œπ.view() for Œπ in sublime.windows() for Œπ in Œπ.sheets()] if Œπ]`
		r.active = sb·µ•`serialize(sublime.active_window().active_sheet().view())`
		;[‚Ä¶r,r.active].filter(Œπ=>Œπ).map(‚Äò.Œπ .host={ enumerable:‚úó,
			get(){‚Ü© sb·µ•` view = deserialize(${@}) ;view.substr(Region(0,view.size())) ` },
			set(Œπ){ sb_edit·µ•(@)` view.replace(edit,Region(0,view.size()),${Œπ}) ` },
			} )
		r‚Äò.push !>( .enumerable= ‚úó ) .Œπ = Œª(Œπ){ sh‚Çê`${Œ∂_inspect(Œπ)} |`` open -a 'Sublime Text.app' -f` ;@.length = 0 ;(=> @ ‚Ä¶‚Üê (sb.tab) ).in(0.02) } # ! wtf async/sync mix
		‚Ü© r }
	‚Ü© sb}
‚ß´[ 'sb[-1]'] ==> => sb.tab[-1].Œπ

‚ß´. _imgur ==> npm`imgur@0.2.1` !>(.setClientId('5358d4a45bafa2e'))
‚ß´. imgur ==> (Œπ=>Œπ+'') ‚â´(@device_memo(Œπ=> Œ†(_imgur.getInfo(Œπ)).then(.data) )) ‚â´(Œ†)‚â´(.then(Œπ=> net1._0_œÜ_seenbydevice0(Œπ.link).then(t=> Œπ ‚Ä¶‚Üê({ @device:t.o+'' }) )))
	!>(Œπ=> Œπ‚Äò.thisdevice .get==>{ t ‚Üê œÜ`${'https://i.imgur.com/'}`+'' ;‚Ü© net1._0_œÜ_seenbydevice0‚Åª¬π().filter(.re`${t}`).map(Œπ‚áí{ ,@device:Œπ ,id:Œπ.replace(re`^.*${t}|\.\w+$`.g,'') }) }) # .map(({Œπ,id})=> imgur(id).catch(‚áí{ ,id ,@device:Œπ }) ) |>(Œ†and) })
‚ß´. imgur_from ==> Œπ=>{ Œπ = œÜ(Œπ+'') ; ‚Ü© @device_memo(h=> JSON.parse( sh·µ•`curl -sH 'Authorization: Client-ID 3e7a4deb7ac67da' -F image=@${Œπ+''} 'https://api.imgur.com/3/upload'` +'') .data.id )(simple_hash(Œπ.buf)) |>(imgur) }

‚ß´[ 'youtube-dl'  ] ==> (a,b)=>{ sh‚Çêi`/usr/local/bin/youtube-dl --extract-audio --audio-format mp3 -o ~/Downloads/${b}'.%(ext)s' ytsearch:${a}` }
‚ß´[ 'youtube-dl-v'] ==> (a,b)=>{ sh‚Çêi`/usr/local/bin/youtube-dl -o ~/Downloads/${b}'.%(ext)s' ytsearch:${a}` }

################################## friend glue #################################
‚ß´. hs·µ• ==> (ss,‚Ä¶Œπs)=>{
	ENC ‚Üê Œπ‚áí
		: Tstr(Œπ)||Tnum(Œπ)? JSON.stringify(Œπ)
		: Tarr(Œπ)? '{'+Œπ.map(ENC).join(',')+'}'
		: '{'+_u(Œπ).map((Œπ,i)=>'['+ENC(i)+']='+ENC(Œπ)).join(',')+'}'
	Œπ ‚Üê simple_template(ss,Œπs,ENC).join('')
	# t ‚Üê sh·µ•`hs -c ${Œπ}`
	t ‚Üê sh·µ•`/usr/local/bin/hs -c ${Œπ}`
	# t ‚Üê child_ process.spawnSync(which('hs'),['-c',Œπ]).stdout
	t ‚Üê (t+'').split('\n')[-1] ;‚Ü© or‚àÖ( catch_Œπ(=> JSON.parse(t)),t ) }

‚ß´. ts·µ• ==> (ss,‚Ä¶Œπs)=>{
	ENC ‚Üê JSON.stringify ;Œπ ‚Üê simple_template(ss,Œπs).map(Œπ=> !Tstr(Œπ)? ENC(Œπ.raw) : Œπ).join('')
	Œπ = 'require "totalspaces2" ;TS = TotalSpaces2 ;'+Œπ
	PORT = 34290
	R ‚Üê => JSON.parse(fs_ipc_emit(PORT,Œπ))[0]
	launch_serv ‚Üê =>{
		;(sh·µ•`gem list`+'').re`(^|\n)totalspaces2 ` || ‚ÄΩ
		t ‚Üê œÜ`/tmp/evalserv_${random_id(9)}.rb`
		t.text = String.raw`#!/usr/bin/env ruby
			require "socket" ;require "json"
			server = TCPServer.new("localhost",${PORT})
			loop do
			  t = server.accept
			  r = JSON.generate([eval(File.read("/tmp/fs_ipc_#{${PORT}}"))])
			  t.print "HTTP/1.1 200 OK\r\n"+"Content-Type: text/plain\r\n"+"Content-Length: #{r.bytesize}\r\n"+"Connection: close\r\n"+"\r\n"+r
			  t.close
			end`
		sh·µ•`chmod +x ${t}`
		node.child_process.spawn(t,{shell:‚úì,detached:‚úì,stdio:'ignore'}).unref()
		# process_spawn('/bin/sh',{ ,args:['-c',t+''] ,child:‚úó })
		}
	try{‚Ü© R() }catch(e){ e.status===7 && launch_serv() ;sh·µ•`sleep 0.1` ;‚Ü© R() } }

‚ß´. sb·µ• ==> (ss,‚Ä¶Œπs)=>{
	ENC ‚Üê JSON.stringify ;Œπ ‚Üê simple_template(ss,Œπs).map(Œπ=> !Tstr(Œπ)? ENC(Œπ.raw) : Œπ).join('')
	œÜ`/tmp/sbêÖ∞êÖØêÖúêÖÇêÖù`.Œπ = Œπ ;‚Ü© JSON.parse(sh·µ•`curl -s -X PUT localhost:34289`+'') |>(Œπ=> Œπ===null? ‚àÖ : Œπ) }
‚ß´. sb_edit·µ• ==> view=>(ss,‚Ä¶Œπs)=>{ sb·µ•`edit(${view},${py(ss,‚Ä¶Œπs)})` }

‚ß´. terminal_do_script ==>{
	sh.clear = String.raw`/usr/bin/clear && printf %s $'\e[3J'`
	‚Ü© (a,b)=>{ œÜ`/tmp/__¬∑`.Œπ = a ;osa·µ•`terminal: do script "¬∑" ‚Ä¶${b}` } }
‚ß´[ '¬∑'] ==> =>{ t ‚Üê œÜ`/tmp/__¬∑` ;postrun(t.text) ;t.Œπ = ‚àÖ }

################################## see : data ##################################
‚ß´. Tag ==>{
	êÖùêÖØêÖ©êÖùêÖû ‚Üê {}
	êÖùêÖØêÖ©êÖùêÖû.inspect = Œª(d,opt){
		ks ‚Üê (‚Ä¶a)=> ‚âà( new Set(_u.keys(@)).-(['inspect','_']) ,new Set(a) )
		r ‚Üê [ opt.stylize(@.tag,'regexp') ]
		!ks('tag') && r.push( node.util.inspect( ks('tag','Œπ')? @.Œπ : Object.defineProperties({},_u(Object.getOwnPropertyDescriptors(@)).omit('tag','inspect','_')) ,opt) )
		‚Ü© r.join(' ') }
	êÖùêÖØêÖ©êÖùêÖû.‚âà = Œª(Œπ){ Œπ = Tstr(Œπ)? Œπ : Œπ[0] ;‚Ü© @.tag === Œπ }
	‚Ü© (tag,Œπ)=>{ r ‚Üê new_(êÖùêÖØêÖ©êÖùêÖû) ;tag!==‚àÖ &&( r.tag = tag ) ;Œπ!==‚àÖ &&( r.Œπ = Œπ ) ;‚Ü© r } }

‚ß´. ‚ßó ==> (f,opt={})=>{ var {TH=0.4} = opt
	# ! really should include a confidence interval or smth
	r‚Üê0 ;I‚Üê1 ;hr‚Üêhrtime() ;R ‚Üê => Unit(hrtime(hr) / r ,'s')
	t‚Üêf() ;r++
	if( T.Promise(t) ) ‚Ü© Œ†(yes=>{ t.then(Œª Œõ(){ if( hrtime(hr) < TH ){ r++ ;f().then(Œõ) }else yes(R()) }) })
	else{ for(;hrtime(hr) < TH;){ for(i‚Üê0;i<I;i++) f() ;r += I ;I = ceil(I*1.5) } ;‚Ü© R() } }
‚ß´. ‚ßó1 ==> f=>{ hr ‚Üê hrtime() ;f() ;‚Ü© Unit(hrtime(hr),'s') }

################################# see : pending ################################
‚ß´. d ==> (a='.')=>{
	# œÜs ‚Üê '/' |>(Œª me(Œπ){‚Ü© œÜ(Œπ).is_dir? (catch_Œπ(=>fs.readdirSync(Œπ))||[]).map(t=> Œπ+'/'+t).map‚Ä¶(me) : [Œπ] })
	# RangeError: Maximum call stack size exceeded

	# would be neat if this was .Trash aware
	sum ‚Üê 0
	q ‚Üê (Œπ,fl)=> log( (' '.√ó(17)+(Œπ+'').split('').reverse().join('').replace(/(...(?!$))/g,'$1,').split('').reverse().join('')).slice(-17)+'  '+fl )
	node.fs.readdirSync(a).map(fl=>{
		if( œÜ(fl).is_dir ){
			o ‚Üê process.stderr.write ;process.stderr.write = =>{} ;try{ t ‚Üê sh·µ•`du -sk ${a}/${fl}` }catch(e){ t ‚Üê e.stdout } ;process.stderr.write = o
			b ‚Üê +((t+'').re`^\d+`||[0])[0] * 1024 }
		else b ‚Üê œÜ(fl).‚Äñ
		sum += b ;q(b,fl) })
	q(sum,a)

	progress_bar ‚Üê (L,at)=>( ,L -= 2 ,at = floor(at*L) ,'['+('='.√ó(L)+'>').slice(-at)+' '.√ó(L-at)+']' )
	[used,free] ‚Üê (sh·µ•`df -P /`+'').split('\n')[1].split(/ +/g).slice(2).map(Œπ=> (Œπ|0)*512 )
	q(-free,'/ '+progress_bar(80-21,used/(used+free)))
	}

############################## new prelude i guess #############################
‚ß´. slot0 ==> (get,set)=>
	(Œª(Œπ){‚Ü© arguments.length===0? get() : (set(Œπ),Œπ) })
	!>(‚Äò.Œπ .host= {get,set} )

‚ß´. say ==> Œπ=>{ ;hs·µ•`hs.alert(${Œπ+''})` ;nacksoft }
