#################################### prelude ###################################
patcher â† o=>{ seen â† new WeakSet(); â†© Î¹=>{ p â† Object.getPrototypeOf(Î¹); if( seen.has(p) ) â†©; seen.add(p); p â€¦â† (o) } }
# patch_Socket â† Î¹=> Object.getPrototypeOf(Î¹) â€¦â† ({
patch_Socket â† patcher({
	,inspect(d,opt){â†© opt.stylize('<socket>','special') }
	})

##################################### main #####################################
express â† require('express')

server â† express()
	.use((req,res,next)=>{ res.header('Access-Control-Allow-Origin','*').header('Access-Control-Allow-Headers','Origin, X-Requested-With, Content-Type, Accept'); next() }) # enable CORS
	.use(express.static('public'))
	.get('/',(req,res)=>{ res.sendFile(__dirname+'/views/index.html') })
	.listen(65330,=> console.log('Your app is listening at '+server.at) )

io â† require('socket.io')(server)

io.on('connection',client=>{ patch_Socket(client)
	clients_add({ name:ğŸ²id(10), socket:client, addrs:[], connected:âœ“ })
	cl â† clients_by_socket.get(client)
	cl.socket
		.on('disconnect',=>{ cl.connected = âœ—; updated(cl); clients_delete(cl) })
		.on('addr_bit',Î¹=>{ _(cl).addrs.push(Î¹); updated(cl) })
		.on('talk_to',name=>{
			console.log('client talking to',cl,name)
			t â† clients_by_name.get(name)
			if (!t) cl.socket.emit('they_are',{ name, connected:âœ— })
			else{ tell_about_always(cl,t); tell_about_always(t,cl) }
			})
	cl.socket.emit('your_name', cl.name )
	console.log('got client',cl)
	})

tell_about_always â† (a,b)=>{ to_tell_about__add(a,b); tell_about(a,b) }
updated â† cl=>{ [â€¦to_tell_about].forEach(([a,bs])=>{ if (bs.has(cl)) tell_about(a,cl) }); console.log('got updated()',cl) }
tell_about â† (a,b)=>{ t â† _(b).pick('name','addrs','connected'); if (!clients.has(b)) t.addrs = âˆ…; a.socket.emit('they_are',t) }

clients â† new Set()
to_tell_about â† new Map()

clients_by_socket â† new Map()
clients_by_name â† new Map()
to_tell_about__add â† (a,b)=>{tâ†; ( to_tell_about.get(a) || (to_tell_about.set(a,t=new Set()),t) ).add(b) }
clients_add â† Î¹=>{ clients.add(Î¹); clients_by_socket.set(Î¹.socket,Î¹); clients_by_name.set(Î¹.name,Î¹) }
clients_delete â† Î¹=>{ clients.delete(Î¹); clients_by_socket.delete(Î¹.socket); clients_by_name.delete(Î¹.name); to_tell_about.delete(Î¹); [â€¦to_tell_about.values()].forEach(bs=> bs.delete(Î¹) ) }

# make sure it's wss
