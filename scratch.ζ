###################################### ui ######################################
‚ß´. notify ==>{
	# ‚Ä° a mess containing infra ‚Ä°
	json_socket ‚Üê¬†socket=>{ êÖÇêÖ¶êÖÆêÖÉêÖ∞‚Üê; êÖÆêÖ∞êÖÆêÖÇêÖÇ‚Üê; ‚Ü© {
		,to(Œπ){ t‚Üê; (êÖÇêÖ¶êÖÆêÖÉêÖ∞||(êÖÇêÖ¶êÖÆêÖÉêÖ∞=( t= npm`ndjson@1.5.0`.stringify(), t.pipe(socket), t ) )).write(Œπ) }
		,on(f){ (êÖÆêÖ∞êÖÆêÖÇêÖÇ||(êÖÆêÖ∞êÖÆêÖÇêÖÇ= socket.pipe(npm`ndjson@1.5.0`.parse()) )).on('data',f) }
		} }
	ipc_wait ‚Üê f=>{H‚Üê; (H= new net.Server()).listen(0,'localhost').on('connection',socket=> json_socket(socket).on(_.once(Œπ=>{ socket.destroy(); H.close(); f(Œπ) })) ) ;‚Ü© Œ†(yes=> H.on('listening',yes.P(H)) ) }

	‚Ü© Œπ=>{ Tstr(Œπ) &&( Œπ = Œπ.re`\n`? Œπ.re`^(.*?)\n([^]*)`.slice(1) : Œπ.re` `? Œπ.re`^(.*?) ([^]*)`.slice(1) : [Œπ] )
		‚Ü© Œ†(yes=> ipc_wait(yes).then(H=>
			hs·µ•`hs.notify.new(
				function(x) x:withdraw(); hs.socket.new():connect('localhost',${H.address().port}):write(hs.json.encode({ at=x:actualDeliveryDate() })..'\n') end
				,{ title=${Œπ[0]}, informativeText=${Œπ[1]||''}, otherButtonTitle='\u{2063}', actionButtonTitle='\u{2063}', }
				):send()`
			) ) } }

################################### data glue ##################################
‚ß´. wikipedia_source ==> page=> JSON.parse(GET_L(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(page)}&prop=revisions&rvprop=content&format=json`,1e6)+'').query.pages |> (Œπ=> _.values(Œπ)[0].revisions[0]['*'] )

################################# service glue #################################
‚ß´. hs·µ• ==> (ss,‚Ä¶Œπs)=>{
	ENC ‚Üê Œπ=> Tstr(Œπ) || Tnum(Œπ)? JSON.stringify(Œπ) : ‚ÄΩ; Œπ ‚Üê simple_template(ss,Œπs).map(Œπ=> !Tstr(Œπ)? ENC(Œπ.raw) : Œπ).join('')
	# t ‚Üê sh·µ•`hs -c ${Œπ}`
	t ‚Üê sh·µ•`/usr/local/bin/hs -c ${Œπ}`
	# t ‚Üê child_ process.spawnSync(which('hs'),['-c',Œπ]).stdout
	t ‚Üê (t+'').split('\n')[-1]; r ‚Üê catch_Œπ(=> JSON.parse(t)[0]) ;‚Ü© r!==‚àÖ?r: t }

‚ß´. ts·µ• ==> (ss,‚Ä¶Œπs)=>{
	ENC ‚Üê JSON.stringify; Œπ ‚Üê simple_template(ss,Œπs).map(Œπ=> !Tstr(Œπ)? ENC(Œπ.raw) : Œπ).join('')
	Œπ = 'require "totalspaces2"; TS = TotalSpaces2; '+Œπ
	PORT = 34290
	R ‚Üê => JSON.parse(fs_ipc_emit(PORT,Œπ))[0]
	launch_serv ‚Üê =>{
		;(sh·µ•`gem list`+'').re`(^|\n)totalspaces2 ` || ‚ÄΩ
		t ‚Üê œÜ`/tmp/evalserv_${random_id(9)}.rb`
		t.text = String.raw`#!/usr/bin/env ruby
			require "socket"; require "json"
			server = TCPServer.new("localhost",${PORT})
			loop do
			  t = server.accept
			  r = JSON.generate([eval(File.read("/tmp/fs_ipc_#{${PORT}}"))])
			  t.print "HTTP/1.1 200 OK\r\n"+"Content-Type: text/plain\r\n"+"Content-Length: #{r.bytesize}\r\n"+"Connection: close\r\n"+"\r\n"+r
			  t.close
			end`
		sh·µ•`chmod +x ${t}`
		require('child_process').spawn(t,{shell:‚úì,detached:‚úì,stdio:'ignore'}).unref()
		# process_spawn('/bin/sh',{ ,args:['-c',t+''] ,child:‚úó })
		}
	try{‚Ü© R() }catch(e){ e.status===7 && launch_serv() ;sleep(0.1) ;‚Ü© R() } }

############################ user's art or something ###########################
‚ß´. moon ==> Œπ=>{ Œπ||(Œπ=Time()); moons ‚Üê [‚Ä¶'üåëüåíüåìüåîüåïüåñüåóüåò'] ;‚Ü© moons[floor((npm`suncalc@1.7.0`.getMoonIllumination(Œπ).phase * moons.‚Äñ + 0.5) % moons.‚Äñ)] }

‚ß´. nice_url ==> Œπ=>{t‚Üê; Uri ‚Üê npm`urijs@1.18.12`; {sourcemap} ‚Üê Œπ; Œπ=Œπ+''
	# very nice google maps urls
	# if url ‚âà google.com/maps/
	# fetch short url:
	# 	# @2016-08-18 wait-click $('#searchbox-hamburger')
	# 	wait-click $('[guidedhelpid="searchbox_hamburger"]')
	# 	wait-click $('[jsaction="settings.share"]')
	# 	wait-check $('#share-short-url')
	# 	t ‚Üê $('.widget-share-link-url').val() wait Œπ=> Œπ.re`^https?://goo.gl/maps/`
	# 	return t
	# 	$('.modal-container').click()
	# wait-check: if not $`${Œπ}:checked`; Œπ.click(); wait for $`${Œπ}:checked`
	# wait-click: wait for Œπ.‚Äñ; Œπ.click()
	# decode: parse curl https://goo.gl/maps/7s6wKcW8zUC2

	if (t=Œπ.re`^"(.*)"$`) ‚Ü© '‚Äú'+t[1]+'‚Äù' # ! bad hack

	apply_regexes ‚Üê regs=> multiline(regs).split(/\n/g).map(Œª(t){ [a,b] ‚Üê t.split(/  +/g); Œπ = Œπ.replace(RegExp(a),b) })
	URL ‚Üê /\b(?:(?:https?|chrome):\/\/|(?:file|mailto):)(?:[^\s‚Äú‚Äù"<>]*\([^\s‚Äú‚Äù"<>]*\))?(?:[^\s‚Äú‚Äù"<>]*[^\s‚Äú‚Äù"<>)\]}‚ü©?!,.:;])?/g
	parse_alicetext ‚Üê Œπ=> _.zip(Œπ.split(URL).map(Œπ‚áí {type:'text', Œπ}), (Œπ.match(URL)||[]).map(Œπ‚áí {type:'url', Œπ}))._.flatten(‚úì).filter(Œπ=> !(Œπ === ‚àÖ || (Œπ.type === 'text' && Œπ.Œπ === '')))

	# Œπ = parse_alicetext(Œπ).map(Œª(Œπ){t‚Üê; Œπ.type==='url' && (t=Uri(Œπ.Œπ)).domain()+t.path()==='google.com/webhp' && t.path('/search') && (Œπ.Œπ = t+'') ;‚Ü© Œπ})._.map('Œπ').join('')

	if (sourcemap && sourcemap.title && sourcemap.url && (t=Uri(Œπ.slice(‚Ä¶sourcemap.url)),
		t.domain() in {'github.com':0} ||
		t.domain()+t.path()==='google.com/search'
		)) Œπ = Œπ.slice(‚Ä¶sourcemap.url)
	
	Œπ = Œπ.replace(/%CE%B6/g,'Œ∂')
	apply_regexes(Œª(){/*
	\bhttps://         http://
	\b(http://)www\.   $1
	\b(http://)(?:mail\.)?(google\.com/mail/)u/0/[?&]?#(?:(?:label|search)/[\w%+]+|\w+)/(\w+)        $1$2#all/$3
	 - Gmail( http://google\.com/mail/)                $1
	 - [\w.]+@gmail\.com( http://google\.com/mail/)    $1
	Fwd: (.* http://google\.com/mail/)                 $1
	\b(http://)en\.(?:m\.)?(wikipedia\.org/)           $1$2
	\b(http://)youtube\.com/watch[?&]v=([\w-_]+)       $1youtu.be/$2
	\b(http://youtu\.be/[\w-_]+)[?&]feature=youtu\.be  $1
	\b(http://youtu\.be/[\w-_]+)&(\S*)$                $1?$2
	 - YouTube( http://youtu\.be/)                     $1
	 \([oO]fficial [vV]ideo\)( http://youtu\.be/)      $1
	\b(http://)smile\.(amazon\.com/)                   $1$2
	\b(http://docs\.google\.com/document/d/[\w_-]+)/edit(?:[?&]ts=\w+)?$  $1
	\b(http://docs\.google\.com/spreadsheets/d/[\w_-]+)/edit(?:#gid=0)?$  $1
	 - Google Docs( http://docs\.google\.com/)         $1
	\b(http://dropbox\.com/\S*)[?&]dl=0$               $1
	\b(http://)facebook(\.com/)                        $1fb$2
	\b(http://fb\.com/)profile\.php\?id=               $1
	\(\d+\) (.* http://fb\.com/)                       $1
	 - Wikipedia, the free encyclopedia( http://wikipedia\.org/)  $1
	 - Album on Imgur( http://imgur\.com/)             $1
	 - Google Maps( http://google\.com/maps/)          $1
	*/})

	Œπ = parse_alicetext(Œπ).map(Œπ=>{t‚Üê;
		if (Œπ.type === 'url') {
			u ‚Üê Uri(Œπ.Œπ)
			switch (u.domain()) { default: ‚Ü© Œπ
				break; case 'amazon.com':
					u.removeSearch(['sa-no-redirect','keywords','qid','ie','s','sr','tag','linkCode','camp','creative','creativeASIN'])
					u.filename().re`^ref=[\w_]+$` && u.filename('')
					if (t=u.resource().re`^/(?:[\w-]+/)?(?:dp|gp)/(?:product/)?(\w+)/?$`) {Œπ.Œπ = 'http://amzn.com/'+t[1] ;‚Ü© Œπ}
				break; case 'fb.com': u.removeSearch(['fref','hc_location','_rdr','pnref'])
				break; case 'google.com': if(_.isEqual( u.segment(),['search'] )){ u.removeSearch(['gws_rd','aqs','sourceid','es_sm','ie']); u.hasSearch('q') && u.removeSearch('oq') }
				}; Œπ.Œπ = u+'' }
		‚Ü© Œπ}).map(.Œπ).join('')

	apply_regexes(Œª(){/*
	: \d{5,}: Amazon(?:Smile)?: Books( http://amzn.com/)        $1
	*/})

	Œπ = parse_alicetext(Œπ).map(Œπ=>{t‚Üê;
		if (Œπ.type === 'url') {
			u ‚Üê Uri(Œπ.Œπ)
			if( Œπ.Œπ.re`\)$` && u.hash()==='' ) Œπ.Œπ += '#'
			}
		‚Ü© Œπ}).map(.Œπ).join('')

	#################################### todo ####################################
	# http://smile.amazon.com/gp/product/0300078153
	# Seeing like a State http://amzn.com/0300078153

	# https://docs.google.com/spreadsheets/d/1wfFMPo8n_mpcoBCFdsIUUIt7oSm7d__Duex51yejbBQ/edit#gid=0
	# http://goo.gl/0nrUfP

	# generalize the ‚Äúfix & to ?‚Äù to many different things

	# http://www.ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility/
	# A Big Little Idea Called Legibility http://ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility/
	# http://ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility
	# http://ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility (3K words)

	# decodeURI('https://www.google.com/search?q=%28cos%28x%29-x%2F%2810*%CF%80%29%29%5E2%2C+cos%28x%29%5E2%2C+2*%28-x%2F%2810*%CF%80%29%29*cos%28x%29%2C+%28-x%2F%2810*%CF%80%29%29%5E2&oq=%28cos%28x%29-x%2F%2810*%CF%80%29%29%5E2%2C+cos%28x%29%5E2%2C+2*%28-x%2F%2810*%CF%80%29%29*cos%28x%29%2C+%28-x%2F%2810*%CF%80%29%29%5E2&gs_l=psy-ab.3...106740.118625.0.119014.18.18.0.0.0.0.163.1395.16j1.17.0....0...1.1.64.psy-ab..2.0.0.9dJSX0MrIe0')
	# https://www.google.com/search?q=(cos(x)-x%2F(10*œÄ))^2%2C+cos(x)^2%2C+2*(-x%2F(10*œÄ))*cos(x)%2C+(-x%2F(10*œÄ))^2&oq=(cos(x)-x%2F(10*œÄ))^2%2C+cos(x)^2%2C+2*(-x%2F(10*œÄ))*cos(x)%2C+(-x%2F(10*œÄ))^2&gs_l=psy-ab.3...106740.118625.0.119014.18.18.0.0.0.0.163.1395.16j1.17.0....0...1.1.64.psy-ab..2.0.0.9dJSX0MrIe0
	# https://www.google.com/search?q=(cos(x)-x%2F(10*œÄ))^2%2C+cos(x)^2%2C+2*(-x%2F(10*œÄ))*cos(x)%2C+(-x%2F(10*œÄ))^2&oq=(cos(x)-x%2F(10*œÄ))^2%2C+cos(x)^2%2C+2*(-x%2F(10*œÄ))*cos(x)%2C+(-x%2F(10*œÄ))^2
	# https://www.google.com/search?q=(cos(x)-x/(10*œÄ))^2,+cos(x)^2,+2*(-x/(10*œÄ))*cos(x),+(-x/(10*œÄ))^2&oq=(cos(x)-x/(10*œÄ))^2,+cos(x)^2,+2*(-x/(10*œÄ))*cos(x),+(-x/(10*œÄ))^2

	‚Ü© Œπ }
