### https://github.com/ggreer/the_silver_searcher needs these ascii characters to see this file ###############################################################################################################################################################################################################################################################################################################

#################################### ui glue ###################################
â§«. notify ==>{
	# infrastruk mess
	json_ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘ â† (ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘)=>{ ğ…‚ğ…¦ğ…®ğ…ƒğ…°â†; ğ…®ğ…°ğ…®ğ…‚ğ…‚â†; â†© {
		,to(Î¹){ tâ†; (ğ…‚ğ…¦ğ…®ğ…ƒğ…°||(ğ…‚ğ…¦ğ…®ğ…ƒğ…°=( t= npm`ndjson@1.5.0`.stringify(), t.pipe(ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘), t ) )).write(Î¹) }
		,on(f){ (ğ…®ğ…°ğ…®ğ…‚ğ…‚||(ğ…®ğ…°ğ…®ğ…‚ğ…‚= ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘.pipe(npm`ndjson@1.5.0`.parse()) )).on('data',f) }
		} }
	ipc_wait â† =>{
		H â† new net.Server().listen(0,'localhost')
		r â† Î (yes=> H.on('connection',ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘=> json_ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘(ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘).on(_.once(Î¹=>{ ğ‘•ğ‘©ğ‘’ğ‘§ğ‘‘.destroy() ;H.close() ;yes(Î¹) })) ))
		â†© [H,r] }

	â†© Î¹=>{ Tstr(Î¹) &&( Î¹ = Î¹.re`\n`? Î¹.re`^(.*?)\n([^]*)`.slice(1) : Î¹.re` `? Î¹.re`^(.*?) ([^]*)`.slice(1) : [Î¹] )
		[H,r] â† ipc_wait()
		H.Î ('listening').then(=> hsáµ¥`hs.notify.new(
			function(x) x:withdraw() ;hs.socket.new():connect('localhost',${H.address().port}):write(hs.json.encode({ at=x:actualDeliveryDate() })..'\n') end
			,{ title=${Î¹[0]}, informativeText=${Î¹[1]||''}, otherButtonTitle='\u{2063}', actionButtonTitle='\u{2063}', }
			):send()` )
		â†© a } }

â§«. set_newtab_bg ==> Î¹=> sháµ¥`ln -sf ${Î¹} ~/code/scratch/net.user/chrome:newtab/it.jpg`

################################### data glue ##################################
â§«. wikipedia_source ==> page=> JSON.parse(GET_L(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(page)}&prop=revisions&rvprop=content&format=json`,1e6)+'').query.pages |> (Î¹=> _.values(Î¹)[0].revisions[0]['*'] )

################################# service glue #################################
â§«. hsáµ¥ ==> (ss,â€¦Î¹s)=>{
	ENC â† Î¹=> Tstr(Î¹) || Tnum(Î¹)? JSON.stringify(Î¹) : â€½ ;Î¹ â† simple_template(ss,Î¹s).map(Î¹=> !Tstr(Î¹)? ENC(Î¹.raw) : Î¹).join('')
	# t â† sháµ¥`hs -c ${Î¹}`
	t â† sháµ¥`/usr/local/bin/hs -c ${Î¹}`
	# t â† child_ process.spawnSync(which('hs'),['-c',Î¹]).stdout
	t â† (t+'').split('\n')[-1] ;r â† catch_Î¹(=> JSON.parse(t)[0]) ;â†© r!==âˆ…?r: t }

â§«. tsáµ¥ ==> (ss,â€¦Î¹s)=>{
	ENC â† JSON.stringify ;Î¹ â† simple_template(ss,Î¹s).map(Î¹=> !Tstr(Î¹)? ENC(Î¹.raw) : Î¹).join('')
	Î¹ = 'require "totalspaces2" ;TS = TotalSpaces2 ;'+Î¹
	PORT = 34290
	R â† => JSON.parse(fs_ipc_emit(PORT,Î¹))[0]
	launch_serv â† =>{
		;(sháµ¥`gem list`+'').re`(^|\n)totalspaces2 ` || â€½
		t â† Ï†`/tmp/evalserv_${random_id(9)}.rb`
		t.text = String.raw`#!/usr/bin/env ruby
			require "socket" ;require "json"
			server = TCPServer.new("localhost",${PORT})
			loop do
			  t = server.accept
			  r = JSON.generate([eval(File.read("/tmp/fs_ipc_#{${PORT}}"))])
			  t.print "HTTP/1.1 200 OK\r\n"+"Content-Type: text/plain\r\n"+"Content-Length: #{r.bytesize}\r\n"+"Connection: close\r\n"+"\r\n"+r
			  t.close
			end`
		sháµ¥`chmod +x ${t}`
		require('child_process').spawn(t,{shell:âœ“,detached:âœ“,stdio:'ignore'}).unref()
		# process_spawn('/bin/sh',{ ,args:['-c',t+''] ,child:âœ— })
		}
	try{â†© R() }catch(e){ e.status===7 && launch_serv() ;sleep(0.1) ;â†© R() } }

############################ user's art or something ###########################
â§«. moon ==> Î¹=>{ Î¹||(Î¹=Time()) ;moons â† [â€¦'ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜'] ;â†© moons[floor((npm`suncalc@1.7.0`.getMoonIllumination(Î¹).phase * moons.â€– + 0.5) % moons.â€–)] }

â§«. nice_url ==> Î¹=>{tâ†; Uri â† npm`urijs@1.18.12` ;{sourcemap} â† Î¹ ;Î¹=Î¹+''
	# very nice google maps urls
	# if url â‰ˆ google.com/maps/
	# fetch short url:
	# 	# @2016-08-18 wait-click $('#searchbox-hamburger')
	# 	wait-click $('[guidedhelpid="searchbox_hamburger"]')
	# 	wait-click $('[jsaction="settings.share"]')
	# 	wait-check $('#share-short-url')
	# 	t â† $('.widget-share-link-url').val() wait Î¹=> Î¹.re`^https?://goo.gl/maps/`
	# 	return t
	# 	$('.modal-container').click()
	# wait-check: if not $`${Î¹}:checked` ;Î¹.click() ;wait for $`${Î¹}:checked`
	# wait-click: wait for Î¹.â€– ;Î¹.click()
	# decode: parse curl https://goo.gl/maps/7s6wKcW8zUC2

	if (t=Î¹.re`^"(.*)"$`) â†© 'â€œ'+t[1]+'â€' # ! bad hack

	apply_regexes â† regs=> multiline(regs).split(/\n/g).map(Î»(t){ [a,b] â† t.split(/  +/g) ;Î¹ = Î¹.replace(RegExp(a),b) })
	URL â† /\b(?:(?:https?|chrome):\/\/|(?:file|mailto):)(?:[^\sâ€œâ€"<>]*\([^\sâ€œâ€"<>]*\))?(?:[^\sâ€œâ€"<>]*[^\sâ€œâ€"<>)\]}âŸ©?!,.:;])?/g
	parse_alicetext â† Î¹=> _.zip(Î¹.split(URL).map(Î¹â‡’ {type:'text', Î¹}), (Î¹.match(URL)||[]).map(Î¹â‡’ {type:'url', Î¹}))._.flatten(âœ“).filter(Î¹=> !(Î¹ === âˆ… || (Î¹.type === 'text' && Î¹.Î¹ === '')))

	# Î¹ = parse_alicetext(Î¹).map(Î»(Î¹){tâ†; Î¹.type==='url' && (t=Uri(Î¹.Î¹)).domain()+t.path()==='google.com/webhp' && t.path('/search') && (Î¹.Î¹ = t+'') ;â†© Î¹})._.map('Î¹').join('')

	if (sourcemap && sourcemap.title && sourcemap.url && (t=Uri(Î¹.slice(â€¦sourcemap.url)),
		t.domain() in {'github.com':0} ||
		t.domain()+t.path()==='google.com/search'
		)) Î¹ = Î¹.slice(â€¦sourcemap.url)
	
	Î¹ = Î¹.replace(/%CE%B6/g,'Î¶')
	apply_regexes(Î»(){/*
	\bhttps://         http://
	\b(http://)www\.   $1
	\b(http://)(?:mail\.)?(google\.com/mail/)u/0/[?&]?#(?:(?:label|search)/[\w%+]+|\w+)/(\w+)        $1$2#all/$3
	 - Gmail( http://google\.com/mail/)                $1
	 - [\w.]+@gmail\.com( http://google\.com/mail/)    $1
	Fwd: (.* http://google\.com/mail/)                 $1
	\b(http://)en\.(?:m\.)?(wikipedia\.org/)           $1$2
	\b(http://)youtube\.com/watch[?&]v=([\w-_]+)       $1youtu.be/$2
	\b(http://youtu\.be/[\w-_]+)[?&]feature=youtu\.be  $1
	\b(http://youtu\.be/[\w-_]+)&(\S*)$                $1?$2
	 - YouTube( http://youtu\.be/)                     $1
	 \([oO]fficial [vV]ideo\)( http://youtu\.be/)      $1
	\b(http://)smile\.(amazon\.com/)                   $1$2
	\b(http://docs\.google\.com/document/d/[\w_-]+)/edit(?:[?&]ts=\w+)?$  $1
	\b(http://docs\.google\.com/spreadsheets/d/[\w_-]+)/edit(?:#gid=0)?$  $1
	 - Google Docs( http://docs\.google\.com/)         $1
	\b(http://dropbox\.com/\S*)[?&]dl=0$               $1
	\b(http://)facebook(\.com/)                        $1fb$2
	\b(http://fb\.com/)profile\.php\?id=               $1
	\(\d+\) (.* http://fb\.com/)                       $1
	 - Wikipedia, the free encyclopedia( http://wikipedia\.org/)  $1
	 - Album on Imgur( http://imgur\.com/)             $1
	 - Google Maps( http://google\.com/maps/)          $1
	*/})

	Î¹ = parse_alicetext(Î¹).map(Î¹=>{tâ†;
		if (Î¹.type === 'url') {
			u â† Uri(Î¹.Î¹)
			switch (u.domain()) { default: â†© Î¹
				break ;case 'amazon.com':
					u.removeSearch(['sa-no-redirect','keywords','qid','ie','s','sr','tag','linkCode','camp','creative','creativeASIN'])
					u.filename().re`^ref=[\w_]+$` && u.filename('')
					if (t=u.resource().re`^/(?:[\w-]+/)?(?:dp|gp)/(?:product/)?(\w+)/?$`) {Î¹.Î¹ = 'http://amzn.com/'+t[1] ;â†© Î¹}
				break ;case 'fb.com': u.removeSearch(['fref','hc_location','_rdr','pnref'])
				break ;case 'google.com': if(_.isEqual( u.segment(),['search'] )){ u.removeSearch(['gws_rd','aqs','sourceid','es_sm','ie']) ;u.hasSearch('q') && u.removeSearch('oq') }
				} ;Î¹.Î¹ = u+'' }
		â†© Î¹}).map(.Î¹).join('')

	apply_regexes(Î»(){/*
	: \d{5,}: Amazon(?:Smile)?: Books( http://amzn.com/)        $1
	*/})

	Î¹ = parse_alicetext(Î¹).map(Î¹=>{tâ†;
		if (Î¹.type === 'url') {
			u â† Uri(Î¹.Î¹)
			if( Î¹.Î¹.re`\)$` && u.hash()==='' ) Î¹.Î¹ += '#'
			}
		â†© Î¹}).map(.Î¹).join('')

	#################################### todo ####################################
	# http://smile.amazon.com/gp/product/0300078153
	# Seeing like a State http://amzn.com/0300078153

	# https://docs.google.com/spreadsheets/d/1wfFMPo8n_mpcoBCFdsIUUIt7oSm7d__Duex51yejbBQ/edit#gid=0
	# http://goo.gl/0nrUfP

	# generalize the â€œfix & to ?â€ to many different things

	# http://www.ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility/
	# A Big Little Idea Called Legibility http://ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility/
	# http://ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility
	# http://ribbonfarm.com/2010/07/26/a-big-little-idea-called-legibility (3K words)

	# decodeURI('https://www.google.com/search?q=%28cos%28x%29-x%2F%2810*%CF%80%29%29%5E2%2C+cos%28x%29%5E2%2C+2*%28-x%2F%2810*%CF%80%29%29*cos%28x%29%2C+%28-x%2F%2810*%CF%80%29%29%5E2&oq=%28cos%28x%29-x%2F%2810*%CF%80%29%29%5E2%2C+cos%28x%29%5E2%2C+2*%28-x%2F%2810*%CF%80%29%29*cos%28x%29%2C+%28-x%2F%2810*%CF%80%29%29%5E2&gs_l=psy-ab.3...106740.118625.0.119014.18.18.0.0.0.0.163.1395.16j1.17.0....0...1.1.64.psy-ab..2.0.0.9dJSX0MrIe0')
	# https://www.google.com/search?q=(cos(x)-x%2F(10*Ï€))^2%2C+cos(x)^2%2C+2*(-x%2F(10*Ï€))*cos(x)%2C+(-x%2F(10*Ï€))^2&oq=(cos(x)-x%2F(10*Ï€))^2%2C+cos(x)^2%2C+2*(-x%2F(10*Ï€))*cos(x)%2C+(-x%2F(10*Ï€))^2&gs_l=psy-ab.3...106740.118625.0.119014.18.18.0.0.0.0.163.1395.16j1.17.0....0...1.1.64.psy-ab..2.0.0.9dJSX0MrIe0
	# https://www.google.com/search?q=(cos(x)-x%2F(10*Ï€))^2%2C+cos(x)^2%2C+2*(-x%2F(10*Ï€))*cos(x)%2C+(-x%2F(10*Ï€))^2&oq=(cos(x)-x%2F(10*Ï€))^2%2C+cos(x)^2%2C+2*(-x%2F(10*Ï€))*cos(x)%2C+(-x%2F(10*Ï€))^2
	# https://www.google.com/search?q=(cos(x)-x/(10*Ï€))^2,+cos(x)^2,+2*(-x/(10*Ï€))*cos(x),+(-x/(10*Ï€))^2&oq=(cos(x)-x/(10*Ï€))^2,+cos(x)^2,+2*(-x/(10*Ï€))*cos(x),+(-x/(10*Ï€))^2

	â†© Î¹ }

################################### new tools ##################################
â§«. lock ==>{
	;fs_close â† util.promisify(fs.close) ;fs_unlink â† util.promisify(fs.unlink) ;fs_open â† util.promisify(fs.open)
	locks â† {}
	â™“_on_exits(=> _.keys(locks).map(lock.un.âš“) )
	ğ…¨ğ…¯ â† id=> Ï†`/tmp/lock_${id}`+''
	lock â† (id,opt)=> fs_open(ğ…¨ğ…¯(id),'wx')
		.then(fd=>{ locks[id] = âœ“ ;â†© fs_close(fd) })
		.catch(e=>{ opt||(opt={}) ;'wait' in opt ||(opt.wait = 0)
			if(!( e.code==='EEXIST' && opt.wait > 0 )) â†© Î (e)
			else{ w â† min(opt.wait,0.1) ;opt.wait -= w ;â†© (=> lock(id,opt)).in_Î (w) }
			})
	lock.un = id=>( delete locks[id] ,fs_unlink(ğ…¨ğ…¯(id)) )
	lock.un.âš“ = id=>{ try{ fs.unlinkSync(ğ…¨ğ…¯(id)) }catch (e){} ;delete locks[id] }
	lock.âˆƒ = id=> fs_open(ğ…¨ğ…¯(id),'r')
		.then(fd=>{ fs.close(fd) ;â†© âœ“ })
		.catch(e=> e.code==='ENOENT'? âœ— : Î (e))
	â†© lock }
